{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "sitecoreSetupSecureUri": {
      "type": "securestring",
      "metadata": {
        "description": "Sitecore secure setup access url."
      }
    },
    "sitecoreLicenseSecureUri": {
      "type": "securestring",
      "metadata": {
        "description": "Sitecore secure license url."
      }
    },
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "MSSitecore",
      "metadata": {
        "description": "A unique prefix for the azure resources (use alphabets and less than 10 characters only)."
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "defaultValue": "SitecoreVNet",
      "metadata": {
        "description": "Virtual network name where the Sitecore resources are deployed."
      }
    },
    "virtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/8",
      "metadata": {
        "description": "Virtual network address space prefix."
      }
    },
    "frontendWebAGSubnetName": {
      "type": "string",
      "defaultValue": "FEAGSubnet",
      "metadata": {
        "description": "Frontend web subnet name."
      }
    },
    "frontendWebAGSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.3.0/24",
      "metadata": {
        "description": "Frontend web subnet prefix."
      }
    },
    "frontendWebSubnetName": {
      "type": "string",
      "defaultValue": "CDSubnet",
      "metadata": {
        "description": "Frontend web subnet name."
      }
    },
    "frontendWebSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/24",
      "metadata": {
        "description": "Frontend web subnet prefix."
      }
    },
    "backendDBSubnetName": {
      "type": "string",
      "defaultValue": "DBSubnet",
      "metadata": {
        "description": "Backend DB subnet name."
      }
    },
    "backendDBSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.1.0/24",
      "metadata": {
        "description": "Backend DB subnet prefix"
      }
    },
    "backendWebSubnetName": {
      "type": "string",
      "defaultValue": "CMSubnet",
      "metadata": {
        "description": "Backend web CM subnet name."
      }
    },
    "backendWebSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.2.0/24",
      "metadata": {
        "description": "Backend web CM subnet prefix"
      }
    },
    "frontendWebAGSize": {
      "type": "string",
      "allowedValues": [
        "Standard_Small",
        "Standard_Medium",
        "Standard_Large"
      ],
      "defaultValue": "Standard_Medium",
      "metadata": {
        "description": "Application gateway size for the frontend web servers."
      }
    },
    "frontendWebAGInstanceCount": {
      "type": "int",
      "allowedValues": [
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ],
      "defaultValue": 2,
      "metadata": {
        "description": "Application gateway instance count for the frontend web servers."
      }
    },
    "backendIPAddresses": {
      "type": "array",
      "defaultValue": [
        {
          "IpAddress": "10.0.0.4"
        },
        {
          "IpAddress": "10.0.0.5"
        }
      ],
      "metadata": {
        "description": "back end pool ip addresses"
      }
    },
    "frontendWebAGCookieBasedAffinity": {
      "type": "string",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Cookie based affinity for the frontend application gateway."
      }
    },

    "sqlServerVMSize": {
      "type": "string",
      "defaultValue": "Standard_DS5_v2",
      "allowedValues": [
        "Standard_DS2",
        "Standard_DS3",
        "Standard_DS4",
        "Standard_DS5",
        "Standard_DS2_v2",
        "Standard_DS3_v2",
        "Standard_DS4_v2",
        "Standard_DS5_v2"
      ],
      "metadata": {
        "description": "Size of the SQL Server VM"
      }
    },
    "sqlServerVMAdminUsername": {
      "type": "string",
      "defaultValue": "sqlservervmadmin",
      "metadata": {
        "description": "SQL Server VM Admin Username."
      }
    },
    "sqlServerVMAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server VM Admin Password."
      }
    },
    "sqlServerSqlLoginName": {
      "type": "string",
      "defaultValue": "sitecoreUser",
      "metadata": {
        "description": "SQL Server SQL login name."
      }
    },
    "sqlServerSqlLoginPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server SQL Login Password"
      }
    },
    "sqlServerDbUsername": {
      "type": "string",
      "defaultValue": "sitecoreUser",
      "metadata": {
        "description": "SQL Server DB User Name"
      }
    },
    "sqlServerDbRoleName": {
      "type": "string",
      "defaultValue": "db_owner",
      "metadata": {
        "description": "SQL Server DB Role Name"
      }
    },
    "sqlServerBootstrapScriptUri": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/suneetnangia/azure-templates-sitecore/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/Scripts/SitecoreDBServerConfigurationBootstrapper.ps1",
      "metadata": {
        "description": "Powershell bootstrap script url which runs other script(s) under VM local admin account on the SQL Server."
      }
    },
    "sqlServerDBConfigScriptUri": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/suneetnangia/azure-templates-sitecore/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/Scripts/SitecoreDBServerConfiguration.ps1",
      "metadata": {
        "description": "Powershell script url which configures Sitecore DB on the server."
      }
    },
    "sqlServerCustomScriptFileToRun": {
      "type": "string",
      "defaultValue": "SitecoreDBServerConfigurationBootstrapper.ps1",
      "metadata": {
        "description": "Script to run on the SQL Server."
      }
    },
    "sqlServerSitecoreDBConfigDSCScriptUri": {
      "type": "string",
      "defaultValue": "https://github.com/suneetnangia/azure-templates-sitecore/raw/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/DSC/SitecoreDBServerSetup.ps1.zip",
      "metadata": {
        "description": "Powershell DSC script url which runs on SQL Server."
      }
    },

    "macDecryption": {
      "type": "string",
      "defaultValue": "AES",
      "metadata": {
        "description": "MAC decryption algorithm."
      }
    },
    "macDecryptionKey": {
      "type": "string",
      "defaultValue": "470D1F481C6389C358F1E08C3DFADDDC4AF2A498597FF894EA40A6D488EDAB0D",
      "metadata": {
        "description": "MAC decryption key."
      }
    },
    "macValidation": {
      "type": "string",
      "defaultValue": "HMACSHA256",
      "metadata": {
        "description": "MAC validation algorithm."
      }
    },
    "macValidationKey": {
      "type": "string",
      "defaultValue": "D451149B2BAC52F48B2CB88160D4189EFEAE7FEC2A83818C19F0D521412C498856498DAC52DB58B28A86A31FE024A6EEC37C720AD261372C80059D09F06C3FD4",
      "metadata": {
        "description": "MAC validation key."
      }
    },

    "cmVMSize": {
      "type": "string",
      "defaultValue": "Standard_DS2_v2",
      "allowedValues": [
        "Standard_DS2",
        "Standard_DS3",
        "Standard_DS4",
        "Standard_DS5",
        "Standard_DS2_v2",
        "Standard_DS3_v2",
        "Standard_DS4_v2",
        "Standard_DS5_v2"
      ],
      "metadata": {
        "description": "Allowed/recommended size of the VMs."
      }
    },
    "cmVMAdminUsername": {
      "type": "string",
      "defaultValue": "cmvmadmin",
      "metadata": {
        "description": "CM VM local admin username."
      }
    },
    "cmVMAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "CM VM local admin password."
      }
    },
    "cmSitecoreConfigScriptUri": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/suneetnangia/azure-templates-sitecore/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/Scripts/SitecoreCDCMServerConfiguration.ps1",
      "metadata": {
        "description": "Powershell script url which configure Sitecore on the CM server."
      }
    },
    "cmCustomScriptFileToRun": {
      "type": "string",
      "defaultValue": "SitecoreCDCMServerConfiguration.ps1",
      "metadata": {
        "description": "Script to configure CM server."
      }
    },
    "cmSitecoreConfigDSCScriptUri": {
      "type": "string",
      "defaultValue": "https://github.com/suneetnangia/azure-templates-sitecore/raw/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/DSC/SitecoreCMCDServerSetup.ps1.zip",
      "metadata": {
        "description": "Powershell DSC script to configure CM server."
      }
    },

    "cdNumberOfInstances": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Number of VMs needed to load balance the traffic to Sitecore CD CM role."
      }
    },
    "cdVMSize": {
      "type": "string",
      "defaultValue": "Standard_DS3_v2",
      "allowedValues": [
        "Standard_DS2",
        "Standard_DS3",
        "Standard_DS4",
        "Standard_DS5",
        "Standard_DS2_v2",
        "Standard_DS3_v2",
        "Standard_DS4_v2",
        "Standard_DS5_v2"
      ],
      "metadata": {
        "description": "Allowed/recommended size of the VMs."
      }
    },
    "cdVMAdminUsername": {
      "type": "string",
      "defaultValue": "cdvmadmin",
      "metadata": {
        "description": "CM CD VM local admin username."
      }
    },
    "cdVMAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "CM CD VM local admin password."
      }
    },
    "cdSitecoreConfigScriptUri": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/suneetnangia/azure-templates-sitecore/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/Scripts/SitecoreCDCMServerConfiguration.ps1",
      "metadata": {
        "description": "Powershell script url which configure Sitecore on the CD CM server."
      }
    },
    "cdCustomScriptFileToRun": {
      "type": "string",
      "defaultValue": "SitecoreCDCMServerConfiguration.ps1",
      "metadata": {
        "description": "Script to configure CD CM server."
      }
    },
    "cdSitecoreConfigDSCScriptUri": {
      "type": "string",
      "defaultValue": "https://github.com/suneetnangia/azure-templates-sitecore/raw/master/Microsoft.Sitecore/Microsoft.Sitecore.ResourceGroupDeployments/DSC/SitecoreCMCDServerSetup.ps1.zip",
      "metadata": {
        "description": "Powershell DSC script to configure CD CM server."
      }
    }
  },
  "variables": {
    "VnetId": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
    "setupSecureUri": "[concat('\"',parameters('sitecoreSetupSecureUri'), '\"')]",
    "licenseSecureUri": "[concat('\"',parameters('sitecoreLicenseSecureUri'), '\"')]",

    "sqlServerResourcePrefix": "[concat(parameters('resourcePrefix'), 'SQL')]",
    "sqlServerImagePublisher": "MicrosoftSQLServer",
    "sqlServerImageOffer": "SQL2014SP1-WS2012R2",
    "sqlServerImageSKU": "Enterprise",
    "sqlServerStorageAccountName": "[toLower(concat('SQL', uniqueString(resourceGroup().id)))]",
    "sqlServerOsDisk": "[concat('http://', variables('sqlServerStorageAccountName'),'.blob.core.windows.net/vhds/', concat(variables('sqlServerResourcePrefix'),'OS.vhd'))]",
    "sqlServerDataDisk1VhdName": "[concat('http://',variables('sqlServerStorageAccountName'),'.blob.core.windows.net/vhds','/',variables('sqlServerResourcePrefix'),'DataDisk1.vhd')]",
    "sqlServerDataDisk2VhdName": "[concat('http://',variables('sqlServerStorageAccountName'),'.blob.core.windows.net/vhds','/',variables('sqlServerResourcePrefix'),'DataDisk2.vhd')]",
    "sqlServerSubnetRef": "[concat(variables('vnetID'),'/subnets/', parameters('backendDBSubnetName'))]",
    "sqlServerSizeOfEachDataDiskInGB": 1023,
    "sqlServerStorageAccountType": "Premium_LRS",
    "sqlServerPublicIPName": "[concat(variables('sqlServerResourcePrefix'),'PublicIP')]",
    "sqlServerPublicIPAddressType": "Dynamic",
    "sqlServerNicName": "[concat(variables('sqlServerResourcePrefix'),'NIC')]",

    "sqlServerLocalUnzippedDBFilesPath": "[concat('\"', 'd:\\SitecoreSetup\\Sitecore 8.1 rev. 151207\\Databases', '\"')]",
    "sqlServerSetupSecureUri": "[concat('\"',parameters('sitecoreSetupSecureUri'), '\"')]",
    "sqlServerCustomScriptCommandToExecute": "[concat('powershell.exe -File', ' ', parameters('sqlServerCustomScriptFileToRun'), ' ', 'd:\\SitecoreSetup.zip', ' ', 'd:\\SitecoreSetup', ' ', variables('sqlServerLocalUnzippedDBFilesPath'), ' ', variables('setupSecureUri'), ' ', 'U:\\Sitecore\\SQL\\Data', ' ', 'L:\\Sitecore\\SQL\\Log', ' ', parameters('sqlServerVMAdminUsername'), ' ', parameters('sqlServerVMAdminPassword'), ' ', parameters('sqlServerSqlLoginName'), ' ', parameters('sqlServerSqlLoginPassword'), ' ', parameters('sqlServerDbUsername'), ' ', parameters('sqlServerDbRoleName'))]",

    "frontendWebAGPrefix": "[concat(parameters('resourcePrefix'), 'FEAG')]",
    "frontendWebAGSubnetRef": "[concat(variables('VnetId'),'/subnets/', parameters('frontendWebAGSubnetName'))]",
    "frontendWebAGId": "[resourceId('Microsoft.Network/applicationGateways',variables('frontendWebAGPrefix'))]",
    "frontendWebAGIPName": "[concat(variables('frontendWebAGPrefix'),'WebAGPublicIP')]",
    "frontendWebAGIPDNSName": "[toLower(concat(variables('frontendWebAGPrefix'),'WebAGIPName'))]",
    "frontendWebAGIPId": "[resourceId('Microsoft.Network/publicIPAddresses',variables('frontendWebAGIPName'))]",
    "frontendWebAGIPRef": "[resourceId('Microsoft.Network/publicIPAddresses',variables('frontendWebAGPrefix'))]",
    "frontendWebAGIPAddressType": "Dynamic",

    "sqlNSGName": "[concat(variables('sqlServerResourcePrefix'),'NSG')]",

    "cmResourcePrefix": "[concat(parameters('resourcePrefix'), 'CM')]",
    "cmImagePublisher": "MicrosoftWindowsServer",
    "cmImageOffer": "WindowsServer",
    "cmImageSKU": "2012-R2-Datacenter",
    "cmSubnetRef": "[concat(variables('vnetId'),'/subnets/',parameters('backendWebSubnetName'))]",
    "cmStorageAccountName": "[toLower(concat('CM',uniqueString(resourceGroup().id)))]",
    "cmPublicIPAddressType": "Dynamic",
    "cmStorageAccountType": "Premium_LRS",

    "cmCoreConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Core\"')]",
    "cmWebConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Web\"')]",
    "cmMasterConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Master\"')]",
    "cmReportingConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Reporting\"')]",
    "cmSessionsConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Sessions\"')]",
    "cmCustomScriptCommandToExecute": "[concat('powershell.exe -File', ' ', parameters('cmCustomScriptFileToRun'), ' ', variables('setupSecureUri'), ' ', variables('licenseSecureUri'), ' ', 'd:\\SitecoreSetup.zip', ' ', 'd:\\SitecoreSetup', ' ', 'C:\\inetpub\\wwwroot\\AzureSitecore\\website', ' ', variables('cmCoreConnStr'), ' ', variables('cmMasterConnStr'), ' ', variables('cmWebConnStr'), ' ', variables('cmReportingConnStr'), ' ', variables('cmSessionsConnStr'), ' ', parameters('macDecryption'), ' ', parameters('macDecryptionKey'), ' ', parameters('macValidation'), ' ', parameters('macValidationKey'))]",

    "cmNSGName": "[concat(variables('cmResourcePrefix'),'NSG')]",

    "cdResourcePrefix": "[concat(parameters('resourcePrefix'), 'CD')]",
    "cdImagePublisher": "MicrosoftWindowsServer",
    "cdImageOffer": "WindowsServer",
    "cdImageSKU": "2012-R2-Datacenter",
    "cdSubnetRef": "[concat(variables('vnetId'),'/subnets/',parameters('frontendWebSubnetName'))]",
    "cdStorageAccountName": "[toLower(concat('CD',uniqueString(resourceGroup().id)))]",
    "cdPublicLBIPName": "[concat(variables('cdResourcePrefix'),'LBPublicIP')]",
    "cdPublicLBIPDNSName": "[toLower(concat(variables('cdResourcePrefix'),'publicLBIPName'))]",
    "cdPublicLBIPId": "[resourceId('Microsoft.Network/publicIPAddresses',variables('cdPublicLBIPName'))]",
    "cdPublicIPAddressType": "Dynamic",
    "cdPublicLBId": "[resourceId('Microsoft.Network/loadBalancers',variables('cdPublicLBName'))]",
    "cdPublicLBName": "[concat(variables('cdResourcePrefix'),'LBPublic')]",
    "cdPublicLBFrontEndIPConfigId": "[concat(variables('cdPublicLBId'),'/frontendIPConfigurations/LoadBalancerFE')]",
    "cdPublicLBPoolId": "[concat(variables('cdPublicLBId'),'/backendAddressPools/BEPool')]",
    "cdPublicLBProbeId": "[concat(variables('cdPublicLBId'),'/probes/tcpPort80Probe')]",
    "cdStorageAccountType": "Premium_LRS",

    "cdCoreConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Core\"')]",
    "cdWebConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Web\"')]",
    "cdMasterConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Master\"')]",
    "cdReportingConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Reporting\"')]",
    "cdSessionsConnStr": "[concat('\"user id=', parameters('sqlServerSqlLoginName'), ';password=', parameters('sqlServerSqlLoginPassword'), ';Data Source=', variables('sqlServerResourcePrefix'), ';Database=Sitecore.Sessions\"')]",
    "cdCustomScriptCommandToExecute": "[concat('powershell.exe -File', ' ', parameters('cdCustomScriptFileToRun'), ' ', variables('setupSecureUri'), ' ', variables('licenseSecureUri'), ' ', 'd:\\SitecoreSetup.zip', ' ', 'd:\\SitecoreSetup', ' ', 'C:\\inetpub\\wwwroot\\AzureSitecore\\website', ' ', variables('cdCoreConnStr'), ' ', variables('cdMasterConnStr'), ' ', variables('cdWebConnStr'), ' ', variables('cdReportingConnStr'), ' ', variables('cdSessionsConnStr'), ' ', parameters('macDecryption'), ' ', parameters('macDecryptionKey'), ' ', parameters('macValidation'), ' ', parameters('macValidationKey'))]",

    "cdNSGName": "[concat(variables('cdResourcePrefix'),'NSG')]"

  },
  "resources": [
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('cdNSGName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "NSG CD Role"
      },
      "properties": {
        "securityRules": [
          {
            "name": "InboundRDPRule",
            "properties": {
              "description": "Allow RDP",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3389",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "[parameters('frontendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "InboundHttpWebRule",
            "properties": {
              "description": "Allow Web",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "80",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "[parameters('frontendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 101,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('cmNSGName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "NSG CM Role"
      },
      "properties": {
        "securityRules": [
          {
            "name": "InboundRDPRule",
            "properties": {
              "description": "Allow RDP",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3389",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "[parameters('frontendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "InboundHttpWebRule",
            "properties": {
              "description": "Allow Web",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "80",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "[parameters('backendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 101,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('sqlNSGName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "NSG DB Role"
      },
      "properties": {
        "securityRules": [
          {
            "name": "InboundRDPRule",
            "properties": {
              "description": "Allow RDP",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3389",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "[parameters('frontendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "InboundCDSQLTCPRule",
            "properties": {
              "description": "Allow SQL Connections",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "1433",
              "sourceAddressPrefix": "[parameters('frontendWebSubnetPrefix')]",
              "destinationAddressPrefix": "[parameters('backendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 101,
              "direction": "Inbound"
            }
          },
          {
            "name": "InboundCMSQLTCPRule",
            "properties": {
              "description": "Allow SQL Connections",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "1433",
              "sourceAddressPrefix": "[parameters('backendWebSubnetPrefix')]",
              "destinationAddressPrefix": "[parameters('backendWebSubnetPrefix')]",
              "access": "Allow",
              "priority": 102,
              "direction": "Inbound"
            }
          }
        ]
      }
    },

    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[parameters('virtualNetworkName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkSecurityGroups/', variables('cdNSGName'))]"
      ],
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('virtualNetworkAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[parameters('frontendWebAGSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('frontendWebAGSubnetPrefix')]"
            }
          },
          {
            "name": "[parameters('frontendWebSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('frontendWebSubnetPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('cdNSGName'))]"
              }
            }
          },
          {
            "name": "[parameters('backendWebSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('backendWebSubnetPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('cmNSGName'))]"
              }
            }
          },
          {
            "name": "[parameters('backendDBSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('backendDBSubnetPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('sqlNSGName'))]"
              }
            }
          }
        ]
      }
    },

    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2015-06-15",
      "name": "[variables('sqlServerStorageAccountName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "accountType": "[variables('sqlServerStorageAccountType')]"
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2015-06-15",
      "name": "[variables('sqlServerPublicIPName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "[variables('sqlServerPublicIPAddressType')]"
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2015-06-15",
      "name": "[variables('sqlServerNicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('sqlServerPublicIPName'))]",
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "[variables('sqlServerPublicIPAddressType')]",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('sqlServerPublicIPName'))]"
              },
              "subnet": {
                "id": "[variables('sqlServerSubnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2015-06-15",
      "name": "[variables('sqlServerResourcePrefix')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', variables('sqlServerStorageAccountName'))]",
        "[concat('Microsoft.Network/networkInterfaces/', variables('sqlServerNicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('sqlServerVMSize')]"
        },
        "osProfile": {
          "computerName": "[variables('sqlServerResourcePrefix')]",
          "adminUsername": "[parameters('sqlServerVMAdminUserName')]",
          "adminPassword": "[parameters('sqlServerVMAdminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[variables('sqlServerImagePublisher')]",
            "offer": "[variables('sqlServerImageOffer')]",
            "sku": "[variables('sqlServerImageSKU')]",
            "version": "latest"
          },
          "dataDisks": [
            {
              "name": "datadisk1",
              "diskSizeGB": "[variables('sqlServerSizeOfEachDataDiskInGB')]",
              "lun": 0,
              "vhd": {
                "Uri": "[variables('sqlServerDataDisk1VhdName')]"
              },
              "createOption": "Empty",
              "caching": "None"
            },
            {
              "name": "datadisk2",
              "diskSizeGB": "[variables('sqlServerSizeOfEachDataDiskInGB')]",
              "lun": 1,
              "vhd": {
                "Uri": "[variables('sqlServerDataDisk2VhdName')]"
              },
              "createOption": "Empty",
              "caching": "ReadOnly"
            }
          ],
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[variables('sqlServerOsDisk')]"
            },
            "diskSizeGB": "1023",
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('sqlServerNicName'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": "false",
            "storageUri": "[concat('http://',variables('sqlServerStorageAccountName'),'.blob.core.windows.net')]"
          }
        }
      },
      "resources": [
        {
          "name": "ConfigureVMDSC",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', variables('sqlServerResourcePrefix'))]"
          ],
          "tags": {
            "displayName": "ConfigureVMDSC"
          },
          "properties": {
            "publisher": "Microsoft.Powershell",
            "type": "DSC",
            "typeHandlerVersion": "2.9",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "modulesUrl": "[parameters('sqlServersitecoreDBConfigDSCScriptUri')]",
              "configurationFunction": "SitecoreDBServerSetup.ps1\\SitecoreDBServerSetup",
              "properties": {
                "nodeName": "[variables('sqlServerResourcePrefix')]"
              }
            },
            "protectedSettings": { }
          }
        },
        {
          "name": "ConfigureVMPS",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', variables('sqlServerResourcePrefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('sqlServerResourcePrefix'), 'ConfigureVMDSC')]"
          ],
          "tags": {
            "displayName": "ConfigureVMPS"
          },
          "properties": {
            "publisher": "Microsoft.Compute",
            "type": "CustomScriptExtension",
            "typeHandlerVersion": "1.4",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "fileUris": [
                "[parameters('sqlServerBootstrapScriptUri')]",
                "[parameters('sqlServerDBConfigScriptUri')]"
              ],
              "commandToExecute": "[variables('sqlServerCustomScriptCommandToExecute')]",
              "timestamp": 12345712
            }
          }
        }
      ]
    },

    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2015-06-15",
      "name": "[variables('cmStorageAccountName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "accountType": "[variables('cmStorageAccountType')]"
      }
    },
    {
      "type": "Microsoft.Compute/availabilitySets",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('cmResourcePrefix'),'AvailabilitySet')]",
      "location": "[resourceGroup().location]",
      "properties": { }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('cmResourcePrefix'),'PublicIP')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "[variables('cmPublicIPAddressType')]"
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('cmResourcePrefix'),'NIC')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', concat(variables('cmResourcePrefix'),'PublicIP'))]",
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('cmResourcePrefix'),'PublicIP'))]"
              },
              "subnet": {
                "id": "[variables('cmSubnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('cmResourcePrefix'))]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', variables('cmStorageAccountName'))]",
        "[concat('Microsoft.Network/networkInterfaces/', concat(variables('cmResourcePrefix'),'NIC'))]",
        "[concat('Microsoft.Compute/availabilitySets/', concat(variables('cmResourcePrefix'),'AvailabilitySet'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('cmVMSize')]"
        },
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets',concat(variables('cmResourcePrefix'),'AvailabilitySet'))]"
        },
        "osProfile": {
          "computerName": "[concat(variables('cmResourcePrefix'))]",
          "adminUsername": "[parameters('cmVMAdminUsername')]",
          "adminPassword": "[parameters('cmVMAdminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[variables('cmImagePublisher')]",
            "offer": "[variables('cmImageOffer')]",
            "sku": "[variables('cmImageSKU')]",
            "version": "latest"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat('http://',variables('cmStorageAccountName'),'.blob.core.windows.net/vhds/', concat(variables('cmResourcePrefix'),'OS.vhd'))]"
            },
            "diskSizeGB": "1023",
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('cmResourcePrefix'),'NIC'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": "false",
            "storageUri": "[concat('http://',variables('cmStorageAccountName'),'.blob.core.windows.net')]"
          }
        }
      },
      "resources": [
        {
          "name": "ConfigureVMDSC",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', concat(variables('cmResourcePrefix')))]"
          ],
          "tags": {
            "displayName": "ConfigureVMDSC"
          },
          "properties": {
            "publisher": "Microsoft.Powershell",
            "type": "DSC",
            "typeHandlerVersion": "2.9",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "modulesUrl": "[parameters('cmSitecoreConfigDSCScriptUri')]",
              "configurationFunction": "SitecoreCMCDServerSetup.ps1\\SitecoreCMCDServerSetup",
              "properties": {
                "nodeName": "[concat(variables('cmResourcePrefix'))]",
                "sitecoreAppPoolName": "SitecoreAppPool",
                "sitecoreWebsiteName": "AzureSitecore"
              }
            },
            "protectedSettings": { }
          }
        },
        {
          "name": "ConfigureVMPS",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', concat(variables('cmResourcePrefix')))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(variables('cmResourcePrefix')), 'ConfigureVMDSC')]"
          ],
          "tags": {
            "displayName": "ConfigureVMPS"
          },
          "properties": {
            "publisher": "Microsoft.Compute",
            "type": "CustomScriptExtension",
            "typeHandlerVersion": "1.4",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "fileUris": [
                "[parameters('cmSitecoreConfigScriptUri')]"
              ],
              "commandToExecute": "[variables('cmCustomScriptCommandToExecute')]",
              "timestamp": 400003
            }
          }
        }
      ]
    },

    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2015-06-15",
      "name": "[variables('cdStorageAccountName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "accountType": "[variables('cdStorageAccountType')]"
      }
    },
    {
      "type": "Microsoft.Compute/availabilitySets",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('cdResourcePrefix'),'AvailabilitySet')]",
      "location": "[resourceGroup().location]",
      "properties": { }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('cdResourcePrefix'),copyindex(),'PublicIP')]",
      "copy": {
        "name": "nicLoop",
        "count": "[parameters('cdNumberOfInstances')]"
      },
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "[variables('cdPublicIPAddressType')]"
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('cdResourcePrefix'),copyindex(),'NIC')]",
      "copy": {
        "name": "nicLoop",
        "count": "[parameters('cdNumberOfInstances')]"
      },
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', concat(variables('cdResourcePrefix'),copyindex(),'PublicIP'))]",
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('cdResourcePrefix'),copyindex(),'PublicIP'))]"
              },
              "subnet": {
                "id": "[variables('cdSubnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[concat(variables('cdPublicLBId'), '/backendAddressPools/BEPool')]"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('cdResourcePrefix'),copyindex())]",
      "location": "[resourceGroup().location]",
      "copy": {
        "name": "nicLoop",
        "count": "[parameters('cdNumberOfInstances')]"
      },
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', variables('cdStorageAccountName'))]",
        "[concat('Microsoft.Network/networkInterfaces/', concat(variables('cdResourcePrefix'),copyindex(),'NIC'))]",
        "[concat('Microsoft.Compute/availabilitySets/', concat(variables('cdResourcePrefix'),'AvailabilitySet'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('cdVMSize')]"
        },
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets',concat(variables('cdResourcePrefix'),'AvailabilitySet'))]"
        },
        "osProfile": {
          "computerName": "[concat(variables('cdResourcePrefix'),copyindex())]",
          "adminUsername": "[parameters('cdVMAdminUsername')]",
          "adminPassword": "[parameters('cdVMAdminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[variables('cdImagePublisher')]",
            "offer": "[variables('cdImageOffer')]",
            "sku": "[variables('cdImageSKU')]",
            "version": "latest"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat('http://',variables('cdStorageAccountName'),'.blob.core.windows.net/vhds/', concat(variables('cdResourcePrefix'),copyindex(),'OS.vhd'))]"
            },
            "diskSizeGB": "1023",
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('cdResourcePrefix'),copyindex(),'NIC'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": "false",
            "storageUri": "[concat('http://',variables('cdStorageAccountName'),'.blob.core.windows.net')]"
          }
        }
      },
      "resources": [
        {
          "name": "ConfigureVMDSC",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', concat(variables('cdResourcePrefix'),copyindex()))]"
          ],
          "tags": {
            "displayName": "ConfigureVMDSC"
          },
          "properties": {
            "publisher": "Microsoft.Powershell",
            "type": "DSC",
            "typeHandlerVersion": "2.9",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "modulesUrl": "[parameters('cdSitecoreConfigDSCScriptUri')]",
              "configurationFunction": "SitecoreCMCDServerSetup.ps1\\SitecoreCMCDServerSetup",
              "properties": {
                "nodeName": "[concat(variables('cdResourcePrefix'),copyindex())]",
                "sitecoreAppPoolName": "SitecoreAppPool",
                "sitecoreWebsiteName": "AzureSitecore"
              }
            },
            "protectedSettings": { }
          }
        },
        {
          "name": "ConfigureVMPS",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', concat(variables('cdResourcePrefix'),copyindex()))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(variables('cdResourcePrefix'),copyindex()), 'ConfigureVMDSC')]"
          ],
          "tags": {
            "displayName": "ConfigureVMPS"
          },
          "properties": {
            "publisher": "Microsoft.Compute",
            "type": "CustomScriptExtension",
            "typeHandlerVersion": "1.4",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "fileUris": [
                "[parameters('cdSitecoreConfigScriptUri')]"
              ],
              "commandToExecute": "[variables('cdCustomScriptCommandToExecute')]",
              "timestamp": 400003
            }
          }
        }
      ]
    },

    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2015-06-15",
      "name": "[variables('frontendWebAGIPName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "[variables('frontendWebAGIPAddressType')]"
      }
    },
    {
      "apiVersion": "2016-06-01",
      "name": "[variables('frontendWebAGPrefix')]",
      "type": "Microsoft.Network/applicationGateways",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
      ],
      "properties": {
        "sku": {
          "name": "[parameters('frontendWebAGSize')]",
          "tier": "Standard",
          "capacity": "[parameters('frontendWebAGInstanceCount')]"
        },
        "gatewayIPConfigurations": [
          {
            "name": "appGatewayIpConfig",
            "properties": {
              "subnet": {
                "id": "[variables('frontendWebAGSubnetRef')]"
              }
            }
          }
        ],
        "frontendIPConfigurations": [
          {
            "name": "appGatewayFrontendIp",
            "properties": {
              "PublicIPAddress": {
                "id": "[variables('frontendWebAGIPId')]"
              }
            }
          }
        ],
        "frontendPorts": [
          {
            "name": "appGatewayFrontendPort",
            "properties": {
              "Port": "80"
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "appGatewayBackendPool",
            "properties": {
              "BackendAddresses": "[parameters('backendIPAddresses')]"
            }
          }
        ],
        "backendHttpSettingsCollection": [
          {
            "name": "appGatewayBackendHttpSettings",
            "properties": {
              "Port": "80",
              "Protocol": "Http",
              "CookieBasedAffinity": "[parameters('frontendWebAGCookieBasedAffinity')]"
            }
          }
        ],
        "httpListeners": [
          {
            "name": "appGatewayHttpListener",
            "properties": {
              "FrontendIpConfiguration": {
                "Id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('frontendWebAGPrefix')), '/frontendIPConfigurations/appGatewayFrontendIp')]"
              },
              "FrontendPort": {
                "Id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('frontendWebAGPrefix')), '/frontendPorts/appGatewayFrontendPort')]"
              },
              "Protocol": "Http",
              "SslCertificate": null
            }
          }
        ],
        "requestRoutingRules": [
          {
            "Name": "roundRobin",
            "properties": {
              "RuleType": "Basic",
              "httpListener": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('frontendWebAGPrefix')), '/httpListeners/appGatewayHttpListener')]"
              },
              "backendAddressPool": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('frontendWebAGPrefix')), '/backendAddressPools/appGatewayBackendPool')]"
              },
              "backendHttpSettings": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('frontendWebAGPrefix')), '/backendHttpSettingsCollection/appGatewayBackendHttpSettings')]"
              }
            }
          }
        ]
      }
    },

    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2015-06-15",
      "name": "[variables('cdPublicLBIPName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "[variables('cdPublicIPAddressType')]",
        "dnsSettings": {
          "domainNameLabel": "[variables('cdPublicLBIPDNSName')]"
        }
      }
    },
    {
      "apiVersion": "2015-05-01-preview",
      "name": "[variables('cdPublicLBName')]",
      "type": "Microsoft.Network/loadBalancers",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('cdPublicLBIPName'))]"
      ],
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "LoadBalancerFE",
            "properties": {
              "publicIPAddress": {
                "id": "[variables('cdPublicLBIPId')]"
              }
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "BEPool"
          }
        ],
        "loadBalancingRules": [
          {
            "name": "Http80",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[variables('cdPublicLBFrontEndIPConfigId')]"
              },
              "backendAddressPool": {
                "id": "[variables('cdPublicLBPoolId')]"
              },
              "protocol": "Tcp",
              "frontendPort": 80,
              "backendPort": 80,
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 5,
              "probe": {
                "id": "[variables('cdPublicLBProbeId')]"
              }
            }
          }
        ],
        "probes": [
          {
            "name": "tcpPort80Probe",
            "properties": {
              "protocol": "tcp",
              "port": 80,
              "intervalInSeconds": 5,
              "numberOfProbes": 2
            }
          }
        ]
      }
    }
  ]
}
